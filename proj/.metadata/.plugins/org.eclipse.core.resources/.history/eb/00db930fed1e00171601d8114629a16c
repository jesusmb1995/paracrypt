#include "AES.hpp"
#include <cstddef>
#include <stdlib.h>
#include "../logging.hpp"

paracrypt::AES::AES()
{
	this->key = NULL;
	this->key_bits = -1;
    this->enRoundKeys = NULL;
    this->deRoundKeys = NULL;
    this->enKeyPropietary = false;
    this->deKeyPropietary = false;
}

paracrypt::AES::~AES()
{
    if (this->keyPropietary && this->roundKeys != NULL)
    if(this->enRoundKeys != NULL) {
    	free(this->enRoundKeys);
    }
    if(this->deRoundKeys != NULL) {
    	free(this->deRoundKeys);
    }
    free(this->key);
}

int paracrypt::AES::setKey(const unsigned char key[], int bits)
{
    if (this->key == NULL) {
    	this->key_bits = bits;
    	int bytes = bits/8;
    	this->key = (unsigned char*) malloc(bytes);
    	memcpy(this->key,key,bytes);
    }
    return 0;
}

// Warning: If we destruct the object who owns the key 
//  we will point to nowhere
int paracrypt::AES::setEncryptionKey(AES_KEY * expandedKey)
{
    if (this->enKeyPropietary && this->enRoundKeys != NULL) {
    	free(this->enKeyPropietary);
    	this->enKeyPropietary = false;
    }
    this->enRoundKeys = expandedKey;
    return 0;
}

int paracrypt::AES::setDecryptionKey(AES_KEY * expandedKey)
{
    if (this->deKeyPropietary && this->deRoundKeys != NULL) {
    	free(this->deKeyPropietary);
    	this->deKeyPropietary = false;
    }
    this->deRoundKeys = expandedKey;
    return 0;
}

AES_KEY *paracrypt::AES::getEncryptionExpandedKey()
{
	if(this->enRoundKeys == NULL) {
		this->enRoundKeys = (AES_KEY *) malloc(sizeof(AES_KEY));
		this->keyPropietary = true;
		AES_set_encrypt_key(key, this->key_bits, this->enRoundKeys);
	}
	return this->enRoundKeys;
}

int paracrypt::AES::setBlockSize(int bits)
{
    return 0;
}
